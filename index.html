#include <WiFi.h>
#include <HTTPClient.h>

// Wi-Fi Credentials
const char* ssid = "RAZER";
const char* password = "shine9823";

// Firebase Settings
const char* firebaseHost = "https://esponline-e1344-default-rtdb.firebaseio.com/";
const char* firebaseSecret = "Atogxa03O7UVVPnYa389eQ7bj7bzzzPnEg2UbUBD";

// Firebase Paths
const char* batteryPath = "/voltage.json";
const char* solarPath = "/solar.json";
const char* wifiSSIDPath = "/wifiSSID.json";
const char* wifiRSSIPath = "/wifiRSSI.json";

// ADC Pins
const int batteryPin = 4;  // GPIO 4 for battery
const int solarPin   = 5;  // GPIO 5 for solar

// ADC reference
const float vRef = 3.3;
const int adcMax = 4095;

// Voltage Divider Ratios
const float batteryRatio = (147000.0 + 10000.0) / 10000.0; // ~15.7
const float solarRatio   = (300000.0 + 10000.0) / 10000.0; // ~31.0

void setup() {
  Serial.begin(115200);
  WiFi.begin(ssid, password);

  Serial.print("Connecting to Wi-Fi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nConnected. IP: " + WiFi.localIP().toString());
}

void loop() {
  float batteryVolt = analogRead(batteryPin) * (vRef / adcMax) * batteryRatio;
  float solarVolt   = analogRead(solarPin)   * (vRef / adcMax) * solarRatio;

  Serial.printf("Battery: %.2f V | Solar: %.2f V\n", batteryVolt, solarVolt);

  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;

    // Battery Voltage Upload
    String batUrl = String(firebaseHost) + batteryPath + "?auth=" + firebaseSecret;
    http.begin(batUrl);
    http.addHeader("Content-Type", "application/json");
    int batCode = http.PUT(String(batteryVolt, 2));
    http.end();

    // Solar Voltage Upload
    String solarUrl = String(firebaseHost) + solarPath + "?auth=" + firebaseSecret;
    http.begin(solarUrl);
    http.addHeader("Content-Type", "application/json");
    int solarCode = http.PUT(String(solarVolt, 2));
    http.end();

    // WiFi SSID Upload
    String ssidUrl = String(firebaseHost) + wifiSSIDPath + "?auth=" + firebaseSecret;
    http.begin(ssidUrl);
    http.addHeader("Content-Type", "application/json");
    int ssidCode = http.PUT("\"" + WiFi.SSID() + "\""); // string in quotes for JSON
    http.end();

    // WiFi RSSI Upload
    String rssiUrl = String(firebaseHost) + wifiRSSIPath + "?auth=" + firebaseSecret;
    http.begin(rssiUrl);
    http.addHeader("Content-Type", "application/json");
    int rssiCode = http.PUT(String(WiFi.RSSI()));
    http.end();

    // Debug prints
    Serial.printf("Upload status: Battery=%d, Solar=%d, SSID=%d, RSSI=%d\n", batCode, solarCode, ssidCode, rssiCode);
  }

  delay(1000); // 1 second interval
}
